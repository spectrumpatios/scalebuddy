<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>ScaleBuddy – Patio Sketch 1 : 100</title>

<!-- PWA hooks -->
<link rel="manifest" href="manifest.json">
<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js');
}
</script>

<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  @page{size:A4 landscape;margin:1cm}
  *,*:before,*:after{box-sizing:border-box}
  body{margin:0;font-family:Segoe UI,Arial,sans-serif;-webkit-print-color-adjust:exact}
  .page{width:calc(29.7cm - 2cm);height:calc(21cm - 2cm);
        display:flex;flex-direction:column;align-items:center;gap:.6cm;margin:0 auto}
  h1{margin:0;font-size:20pt}
  .form-row{display:flex;flex-wrap:wrap;gap:.6cm;align-items:center;justify-content:center}
  .form-row label{font-weight:600;font-size:12pt}
  .form-row input[type=number],.form-row select{width:4cm;padding:.25cm .35cm;border:1px solid #888;border-radius:6mm;font-size:12pt}
  .form-row input[type=number]{text-align:right}
  .form-row input[type=checkbox]{transform:scale(1.2);margin-left:.3cm;cursor:pointer;width:auto}
  .form-row button{padding:.35cm .8cm;border:none;border-radius:6mm;background:#0054a7;color:#fff;font-size:12pt;cursor:pointer}
  #drawing-container{flex:1;width:100%;display:flex;justify-content:center;align-items:center}
  #drawing{background:#fff;border:1px solid #000;border-radius:2mm}
</style>
</head>
<body>
<div class="page">
  <h1>ScaleBuddy · Scale 1 : 100</h1>

  <div class="form-row">
    <label for="length">Length (m):</label><input id="length" type="number" min="0.1" step="0.1">
    <label for="depth">Depth (m):</label><input id="depth"  type="number" min="0.1" step="0.1">

    <label for="style">Style:</label>
    <select id="style">
      <option value="flat"  selected>Flat</option>
      <option value="gable">Gable</option>
    </select>

    <label for="beam">Outer Beam:</label>
    <select id="beam">
      <option value="76x38-1.6">76×38 · 1.6 mm</option>
      <option value="76x38-2.0">76×38 · 2.0 mm</option>
      <option value="100x50">100×50</option>
      <option value="150x50">150×50</option>
      <option value="200x50">200×50</option>
    </select>

    <label for="rafter">Rafter Size:</label>
    <select id="rafter">
      <option value="38" selected>38 mm</option>
      <option value="50">50 mm</option>
    </select>

    <label for="purlins">Purlins:</label><input id="purlins" type="number" min="0" step="1">

    <label for="extended">Posts Extended?</label><input id="extended" type="checkbox">

    <button id="drawBtn" type="button">Draw</button>
  </div>

  <div id="drawing-container"><canvas id="drawing"></canvas></div>
</div>

<!-- *************  START JS  ************* -->
<script>
(() => {
  /* ---------- CONSTANTS ---------- */
  const CM_TO_PX = 37.8;          // 96-dpi cm→px
  const PAD_CM   = 1;             // white margin inside canvas
  const DIM_CM   = 1.5;           // dimension-band thickness
  const EXTRA_GAP_PX = 25;        // extra gap between drawing & dims
  const SCALE_M_CM  = 1;          // 1 m ⇒ 1 cm  (1 : 100)
  const PAGE_W_CM   = 29.7 - 2;   // A4 land. minus 1 cm margin
  const PAGE_H_CM   = 21   - 2;
  const SETBACK_M   = 0.5;        // 500 mm
  const POST_HALF   = 6;          // X half-size
  const GABLE_GAP_M = 0.09;       // 90 mm centre gap

  const SPANS = {                 // max span per beam
    '76x38-1.6': 4,
    '76x38-2.0': 5,
    '100x50'   : 5.5,
    '150x50'   : 6,
    '200x50'   : 6
  };

  /* ---------- DOM ---------- */
  const cvs = document.getElementById('drawing');
  const ctx = cvs.getContext('2d');
  const $   = id => document.getElementById(id);

  $('drawBtn').addEventListener('click', () => {
    const wM = +$('length').value;
    const dM = +$('depth').value;
    if (!wM || !dM) { alert('Enter length & depth'); return; }

    render({
      wM, dM,
      style   : $('style').value,
      beam    : $('beam').value,
      rafter  : +$('rafter').value,
      purlins : +$('purlins').value || 0,
      extended: $('extended').checked
    });
  });

  /* ---------- MAIN DRAW ---------- */
  function render(cfg) {
    /* scale */
    let wCm = cfg.wM * SCALE_M_CM;
    let dCm = cfg.dM * SCALE_M_CM;
    const fit = Math.min(
      (PAGE_W_CM - PAD_CM*2 - DIM_CM) / wCm,
      (PAGE_H_CM - PAD_CM*2 - DIM_CM) / dCm
    );
    wCm *= fit; dCm *= fit;

    const setbackCm = cfg.extended ? SETBACK_M * SCALE_M_CM * fit : 0;
    const roofCm    = dCm - setbackCm;

    /* px sizes */
    const pad  = PAD_CM * CM_TO_PX;
    const band = DIM_CM * CM_TO_PX;
    const wPx  = wCm * CM_TO_PX;
    const dPx  = dCm * CM_TO_PX;
    const roofPx = roofCm * CM_TO_PX;

    cvs.width  = wPx + pad*2 + band + EXTRA_GAP_PX;
    cvs.height = dPx + pad*2 + band + EXTRA_GAP_PX;
    ctx.clearRect(0,0,cvs.width,cvs.height);

    const ox = pad, oy = pad;

    /* ---- 1. GRID ---- */
    ctx.save();
    ctx.strokeStyle='#e0e0e0'; ctx.lineWidth=.4;
    const g = CM_TO_PX*fit;
    for(let x=0;x<=wPx;x+=g){ctx.beginPath();ctx.moveTo(ox+x,oy);ctx.lineTo(ox+x,oy+dPx);ctx.stroke();}
    for(let y=0;y<=dPx;y+=g){ctx.beginPath();ctx.moveTo(ox,oy+y);ctx.lineTo(ox+wPx,oy+y);ctx.stroke();}
    ctx.restore();

    /* ---- 2. FRAME & RING BEAM ---- */
    ctx.strokeStyle='#000'; ctx.lineWidth=2; ctx.strokeRect(ox,oy,wPx,dPx);
    let ringY = oy + dPx;
    if(cfg.extended){
      ctx.save();ctx.strokeStyle='#fff';ctx.lineWidth=2;
      ctx.beginPath();ctx.moveTo(ox,oy+dPx);ctx.lineTo(ox+wPx,oy+dPx);ctx.stroke();ctx.restore();
      ctx.save();ctx.setLineDash([6,4]);ctx.strokeStyle='#d12c00';ctx.lineWidth=2;
      ctx.strokeRect(ox,oy,wPx,roofPx);ctx.restore();
      ringY = oy + roofPx;
    }
    ctx.font='12pt Arial';ctx.textAlign='center';ctx.textBaseline='bottom';
    ctx.fillStyle = cfg.extended ? '#d12c00' : '#000';
    ctx.fillText('Ring Beam', ox+wPx/2, ringY-4);

    /* ---- 3. RAFTERS ---- */
    const maxSpanPx = SPANS[cfg.beam] * CM_TO_PX * fit;
    const bays = Math.ceil(wPx / maxSpanPx);
    const step = wPx / bays;
    const rafterXs=[ox];
    ctx.save();ctx.strokeStyle='#000';ctx.lineWidth=1;
    for(let i=1;i<bays;i++){
      const x=ox+step*i;
      rafterXs.push(x);
      ctx.beginPath();ctx.moveTo(x,oy);ctx.lineTo(x,oy+dPx);ctx.stroke();
      post(x,oy+dPx);
    }
    rafterXs.push(ox+wPx);
    ctx.restore();
    post(ox,oy+dPx); post(ox+wPx,oy+dPx);

    /* ---- 4. PURLINS ---- */
    const pYs=[];
    ctx.save();ctx.strokeStyle='#555';ctx.lineWidth=1;
    const horiz=y=>{ctx.beginPath();ctx.moveTo(ox,y);ctx.lineTo(ox+wPx,y);ctx.stroke();};
    if(cfg.purlins>0){
      if(cfg.style==='flat'){
        const span=ringY-oy,st=span/(cfg.purlins+1);
        for(let i=1;i<=cfg.purlins;i++){const y=oy+st*i;pYs.push(y);horiz(y);}
      }else{
        const span=ringY-oy,cen=oy+span/2,gap=GABLE_GAP_M*SCALE_M_CM*fit*CM_TO_PX;
        if(cfg.purlins===1){pYs.push(cen);horiz(cen);}
        else{
          const m1=cen-gap/2,m2=cen+gap/2;pYs.push(m1,m2);horiz(m1);horiz(m2);
          let rem=cfg.purlins-2,per=Math.floor(rem/2),sd=(span/2-gap/2)/(per+1);
          for(let s=1;s<=per;s++){const yT=m1-sd*s,yB=m2+sd*s;pYs.push(yT,yB);horiz(yT);horiz(yB);}
          if(rem%2){const yE=m1-sd*(per+1);pYs.push(yE);horiz(yE);}
        }
      }
    }
    ctx.restore();

    /* ---- 5. DIMENSIONS ---- */
    dims();

    /* ============ helper ============ */
    function post(cx,cy){
      ctx.save();ctx.strokeStyle='#000';ctx.lineWidth=1.3;
      ctx.beginPath();ctx.moveTo(cx-POST_HALF,cy-POST_HALF);ctx.lineTo(cx+POST_HALF,cy+POST_HALF);
      ctx.moveTo(cx+POST_HALF,cy-POST_HALF);ctx.lineTo(cx-POST_HALF,cy+POST_HALF);ctx.stroke();ctx.restore();
    }
    function tick(x,y){ctx.beginPath();ctx.moveTo(x-4,y);ctx.lineTo(x+4,y);ctx.stroke();}
    function arrow(x0,y0,x1,y1){
      ctx.beginPath();ctx.moveTo(x0,y0);ctx.lineTo(x1,y1);ctx.stroke();
      head(x0,y0,x1,y1);head(x1,y1,x0,y0);}
    function head(x0,y0,x1,y1){
      const h=6,a=Math.atan2(y1-y0,x1-x0);
      ctx.beginPath();ctx.moveTo(x1,y1);
      ctx.lineTo(x1-h*Math.cos(a-Math.PI/6),y1-h*Math.sin(a-Math.PI/6));
      ctx.lineTo(x1-h*Math.cos(a+Math.PI/6),y1-h*Math.sin(a+Math.PI/6));
      ctx.closePath();ctx.fill();}
    function dims(){
      ctx.strokeStyle='#000';ctx.lineWidth=1;ctx.font='10pt Arial';
      /* bottom inner */
      const innerY=oy+dPx+5;
      arrow(ox,innerY,ox+wPx,innerY);
      for(let i=1;i<rafterXs.length;i++){
        tick(rafterXs[i-1],innerY);tick(rafterXs[i],innerY);
        const mid=(rafterXs[i]+rafterXs[i-1])/2;
        const bay=((rafterXs[i]-rafterXs[i-1])/(CM_TO_PX*fit)).toFixed(2);
        ctx.textAlign='center';ctx.textBaseline='top';
        ctx.fillText(`${bay} m / ${cfg.rafter} mm`,mid,innerY+2);
      }
      /* bottom outer */
      const outerY=innerY+18;
      tick(ox,outerY);tick(ox+wPx,outerY);arrow(ox,outerY,ox+wPx,outerY);
      ctx.fillText(`${cfg.wM.toFixed(2)} m`,ox+wPx/2,outerY+2);

      /* right dims */
      if(!pYs.length)return;
      ctx.textAlign='left';ctx.textBaseline='middle';
      const innerX=ox+wPx+5;
      arrow(innerX,oy,innerX,ringY);
      const pts=[oy,...pYs.sort((a,b)=>a-b),ringY];
      for(let i=1;i<pts.length;i++){
        tick(innerX,pts[i-1]);tick(innerX,pts[i]);
        const mid=(pts[i]+pts[i-1])/2;
        const seg=((pts[i]-pts[i-1])/(CM_TO_PX*fit)).toFixed(2);
        ctx.fillText(`${seg} m`,innerX+6,mid);
      }
      const outerX=innerX+18;
      tick(outerX,oy);tick(outerX,ringY);
      arrow(outerX,oy,outerX,ringY);
      ctx.fillText(`${cfg.dM.toFixed(2)} m`,outerX+6,oy+(ringY-oy)/2);
    }
  }
})();
</script>
<!-- *************  END JS  ************* -->
</body>
</html>
